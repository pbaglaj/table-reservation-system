<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <title>Table reservation</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .time-slot {
            width: 80px;
            margin: 5px;
        }
    </style>
</head>
<body class="container mt-5">
<div class="card col-md-6 offset-md-3">
    <div class="card-header bg-primary text-white">
        <h3>Table reservation</h3>
    </div>
    <div class="card-body">

        <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>

        <div class="mb-4">
            <label class="form-label fw-bold">1. Select date:</label>
            <form th:action="@{/reserve/{id}(id=${tableId})}" method="get">
                <input type="date" name="date" class="form-control"
                       th:value="${selectedDate}"
                       th:min="${minDate}"
                       onchange="this.form.submit()">
            </form>
        </div>

        <div class="mb-4">
            <label class="form-label fw-bold">2. Select time:</label>
            <div class="d-flex flex-wrap justify-content-center">
                <th:block th:each="hour : ${#numbers.sequence(12, 21)}">

                    <button type="button"
                            th:with="isPast=${isToday and hour <= currentHour}"
                            th:disabled="${reservedHours.contains(hour) or isPast}"
                            th:classappend="${reservedHours.contains(hour) or isPast} ? 'btn-danger' : 'btn-outline-success'"
                            class="btn time-slot"
                            th:text="${hour} + ':00'"
                            th:onclick="'selectTime(' + ${hour} + ', this)'">
                        12:00
                    </button>

                </th:block>
            </div>
            <div class="text-center mt-2">
                <small class="text-muted" id="selectedTimeDisplay">No time selected</small>
            </div>
        </div>

        <form th:action="@{/reserve}" th:object="${reservationForm}" method="post" onsubmit="return validateForm()">
            <input type="hidden" th:field="*{tableId}">
            <input type="hidden" id="startTime" th:field="*{startTime}">

            <div class="mb-3">
                <label class="form-label">Your name</label>
                <input type="text" th:field="*{name}" class="form-control"
                       th:classappend="${#fields.hasErrors('name')} ? 'is-invalid' : ''">
                <div class="invalid-feedback" th:if="${#fields.hasErrors('name')}" th:errors="*{name}">
                    Name Error
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label">Email</label>
                <input type="email" th:field="*{email}" class="form-control"
                       th:classappend="${#fields.hasErrors('email')} ? 'is-invalid' : ''">
                <div class="invalid-feedback" th:if="${#fields.hasErrors('email')}" th:errors="*{email}">
                    Email Error
                </div>
            </div>

            <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>

            <div th:if="${#fields.hasErrors('startTime')}" class="alert alert-danger">
                <span th:errors="*{startTime}">Date Error</span>
            </div>

            <button type="submit" class="btn btn-success w-100" id="submitBtn" disabled>Submit reservation</button>
            <a href="/tables" class="btn btn-secondary w-100 mt-2">Cancel</a>
        </form>
    </div>
</div>

<script th:inline="javascript">
    /* Pobieramy wybraną datę z Thymeleaf do JS */
    const selectedDate = /*[[${selectedDate.toString()}]]*/ 'default';
    let selectedHour = null;

    function selectTime(hour, btnElement) {
        // Resetujemy style wszystkich przycisków sukcesu (odznaczamy poprzedni)
        document.querySelectorAll('.btn-outline-success').forEach(btn => {
            btn.classList.remove('active');
            btn.classList.remove('bg-success');
            btn.classList.remove('text-white');
        });

        // Zaznaczamy kliknięty przycisk
        btnElement.classList.add('active');
        btnElement.classList.add('bg-success');
        btnElement.classList.add('text-white');

        // Zapamiętujemy godzinę i aktualizujemy widok
        selectedHour = hour;
        document.getElementById('selectedTimeDisplay').innerText =
            'Selected: ' + selectedDate + ' at ' + hour + ':00';

        // Formatujemy datę do ISO (yyyy-MM-ddTHH:mm:ss) dla backendu
        // Dodajemy wiodące zero dla godziny jeśli potrzebne (choć tu startujemy od 12)
        const timeString = (hour < 10 ? '0' : '') + hour + ':00:00';
        document.getElementById('startTime').value = selectedDate + 'T' + timeString;

        // Odblokowujemy przycisk submit
        document.getElementById('submitBtn').disabled = false;
    }

    function validateForm() {
        if (!selectedHour) {
            alert("Please select a time!");
            return false;
        }
        return true;
    }
</script>

</body>
</html>